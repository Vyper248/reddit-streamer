<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title></title>
    <link rel="stylesheet" type="text/css" href="semantic.min.css">
    <style>
    
        body {
            padding: 20px;
        }
    
        .threadContainer{
            border: 1px solid black;
            padding: 20px;
            margin: 5px;
            border-radius: 5px;
        }
        
        .sub {
            color: darkgray;
        }
        
        .threadCount {
            color: darkgray;
            margin: 0px;
        }
        
        h2 {
            margin-bottom: 0px;
        }
        
        h4 {
            padding-top: 0px;
            padding-bottom: 0px;
            margin: 0px;
        }
        
        a {
            color: black;
            text-decoration: none;
        }
        
        #muteBtn {
            float: right;
            margin-top:15px;
        }
        
        .ui.label {
            margin: 5px;
        }
        
        .closed {
            height: 30px;
            overflow: hidden;
        }
        
        #comment.closed {
            padding: 5px;
            padding-left: 14px;
        }
        
        .pointer {
            cursor: pointer;
        }
        
        .OP {
            color: blue;
        }
		
		body {
			padding-top: 60px;
		}
		
		.ui.menu .centered.menu {
			margin: auto;
			border-left: 1px solid rgba(34,36,38,.1);
		}
		
		.multiBtn {
			cursor: pointer;
		}
		
		.highlighted {
			color: blue;
		}
		
		#editMultiBtn {
			position: absolute;
			right: 0px;
		}
        
    </style>
</head>

<body ng-app="redditApp" ng-controller="myCtrl">

	<div class="ui fixed menu">
		<div class="centered menu">
			<a class="item" ng-click="selectMulti('All')" ng-style="checkMulti('All')">All</a>
			<a class="item" ng-repeat="multi in multis" ng-click="selectMulti(multi.name)" ng-style="checkMulti(multi.name)">{{multi.name}}</a>
			
		</div>
		<a class="right item" id="editMultiBtn" ng-click="editMultis()"><i class="cog icon"></i></a>
	</div>

    <div class="ui center aligned container">
        
        <h2 class="ui heading">Reddit Streamer</h2>
        <div class="threadCount">New threads: {{newItems()}}</div>
        
        <div class="ui grid">
        
            <div class="left aligned fourteen wide column">
                
                <div class="ui dropdown button">
                  <input type="hidden" name="filters">
                  <span class="text"><i class="search icon"></i>Search Subs</span>
                  <div class="menu">
                    <div class="ui icon search input">
                        <i class="search icon"></i>
                      <input type="text" placeholder="Search subs..." ng-model="searchText" ng-change="searchSubs()">
                    </div>
                    <div class="divider"></div>
                    <div class="header">
                      Subreddit
                    </div>
                    <div class="scrolling menu">
                      <div class="item" ng-repeat="result in searchResults" data-value="{{result}}">
                        {{result}}
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="ui label" ng-repeat="sub in subArray">{{sub}}<i class="delete icon" ng-click="removeSub(sub)"></i></div>
            </div>
            
            <div class=" right aligned two wide column">
                <div class="ui checkbox" id="muteBtn">
                    <input type="checkbox" ng-model="mute">
                    <label>Mute?</label>
                </div>
            </div>
        
        </div>
        
       
        
        <div class="threadContainer ui left aligned segment" ng-repeat="thread in currentThreads" style="border-color: {{thread.colour}}" ng-click="removeColour(thread)">
            <h4>
                <a href="{{thread.url}}" target="_blank">
                    <span class="sub">{{thread.sub}}</span> - {{thread.title}}
                </a>
            </h4>
            <p class="sub">{{thread.domain}} - {{thread.author}}</p>
            <p>{{thread.description}}</p>
            <a  target="_blank" class="sub pointer" ng-click="showComments(thread)">{{thread.numberComments}} Comments</a> - 
            <a href="http://www.reddit.com{{thread.comments}}" target="_blank" class="sub">Open on Reddit</a>
        </div>
        
        
        <div class="ui longer special modal" id="commentModal">
          <div class="header" id="title">Header</div>
          <div class="scrolling content" id="comments">
              
          </div>
          <div class="actions">
            <div class="ui black deny button">
              Close
            </div>
          </div>
        </div>
		
		<div class="ui longer special mini modal" id="multiModal">
          <div class="header" id="title">Groups</div>
          <div class="scrolling content" id="multis">
			  <div class="ui segments">
				  <div class="ui segment" ng-repeat="multi in multis">
				  	<div class="ui input">
						<input type="text" ng-value="multi.name" ng-blur="editMultiName(multi, $event)"/>
					</div>
					<div class="ui right floated button" ng-click="deleteMulti(multi)"><i class="delete icon" style="margin: 0px;!important"></i></div>
				  </div>
			  </div>
			  <div class="ui blue button" ng-click="addMulti()">Add New</div>
          </div>
          <div class="actions">
            <div class="ui black deny button">
              Close
            </div>
          </div>
        </div>
        
    </div>
    
 	
    <script src="jquery.min.js"></script>
    <script src="angular.min.js"></script>
    <script src="semantic.min.js"></script>
    <script src="howler/howler.min.js"></script>
    <script>
        
         
    
        var sound = new Howl({
            src: ['howler/squiggle.mp3'],
            volume: 0.25,
        });
        
        var app = angular.module('redditApp', []);
        app.controller('myCtrl', function($scope) {  
			
			//function to add sub to array
             $('.ui.dropdown').dropdown({
                onChange: function(value, text){
                    if (value && $scope.subAlreadyAdded(value) === false){
                        $scope.subs += '+'+value;
                        $scope.subArray.push(value);
						$scope.updateStorage();
                        $scope.$apply();
                        $('.ui.dropdown').dropdown('set text', '<i class="search icon"></i>Search Subs');
                    } else {
                        $('.ui.dropdown').dropdown('set text', '<i class="search icon"></i>Search Subs');
                    }                    
                }
            });  
			
			//variables for multis
			//localStorage.removeItem('currentMulti');
			//localStorage.removeItem('multis');
			$scope.currentMulti = localStorage.currentMulti || 'All';
			$scope.multis = localStorage.multis;
			if ($scope.multis === undefined) $scope.multis = JSON.stringify([{name: 'Subs', array: ['All']}, {name: 'Playstation', array: ['PSVR','PS4']}]);
			$scope.multis = JSON.parse($scope.multis);
			
			//function to get style for currentMulti
			$scope.checkMulti = function(multi){
				if (multi === $scope.currentMulti){
					return {backgroundColor: 'lightgray'};
				} else {
					return {};
				}
			}
            
			//remove sub from array and update storage
            $scope.removeSub = function(sub){
                $scope.subArray.splice($scope.subArray.indexOf(sub), 1);
                if ($scope.subArray.length === 0) $scope.subArray = ['All'];
                $scope.subs = $scope.subArray.join('+');
                $scope.updateStorage();
            }
            
			//check if sub is already added
            $scope.subAlreadyAdded = function(sub){
                if ($scope.subArray.indexOf(sub) !== -1) return true;
                else return false;
            }
            
            //update local storage if user changes subs selection
            $scope.updateStorage = function(){
                localStorage.setItem('subs', $scope.subs);
				localStorage.setItem('multis', JSON.stringify($scope.multis));
				localStorage.setItem('currentMulti', $scope.currentMulti);
            };
			
			//when user selects a multi, switch current sub array to that one
			$scope.selectMulti = function(multi){
				if (multi === 'All') {
					$scope.subArray = [];
					$scope.multis.forEach((multi) => $scope.subArray.push(...multi.array));
					$scope.subs = $scope.subArray.join('+');
					$scope.currentMulti = 'All';
					$scope.updateStorage();
				} else {
					$scope.subArray = $scope.multis.find((group) => group.name === multi).array;
					$scope.subs = $scope.subArray.join('+');
					$scope.currentMulti = multi;
					$scope.updateStorage();
				}
				$scope.currentThreads = [];
				getNewData();
			}
			
			//setup initial variables
			$scope.selectMulti($scope.currentMulti);
			
			$scope.editMultis = function(){
				$('#multiModal').modal('show');
			};
			
			//edit the name of a multi
			$scope.editMultiName = function(multi, event){
				let newValue = event.currentTarget.value;
				if (newValue.length === 0) newValue = 'Empty';
				if ($scope.currentMulti === multi.name) $scope.currentMulti = newValue;
				multi.name = newValue;
				$scope.updateStorage();
			}
			
			//add a new multi with default values
			$scope.addMulti = function(){
				$scope.multis.push({name: 'New', array: []});
			}
			
			$scope.deleteMulti = function(multi){
				let index = $scope.multis.indexOf(multi);
				$scope.multis.splice(index, 1);
				$scope.updateStorage();
			}
            
            //storage of items already seen, so they don't turn red again
            let clickedArray = localStorage.clicked;
            if (clickedArray === undefined) $scope.clickedOn = [];
            else $scope.clickedOn = clickedArray.split(',');
            
            //remove red outline when user clicks on a thread
            $scope.removeColour = function(thread){
                if (thread.colour !== ''){
                    thread.colour = '';
                    $scope.clickedOn.push(thread.id);
                    localStorage.setItem('clicked', $scope.clickedOn.join(','));
                }
            }
            
            //return number of new items
            $scope.newItems = function(){
                let newItems = $scope.currentThreads.filter((thread) => thread.colour !== '');
                if (newItems !== undefined) {
                    return newItems.length;
                }
                return 0;
            }
            
            //open modal view with comments
            $scope.currentComments = [];
            $scope.currentThread = {};
            $scope.showComments = function(thread){
                let url = "http://www.reddit.com/r/"+thread.sub+"/"+thread.id+".json";
                $.get(url, function(data){
                    let comments = data[1].data.children;
                    $('#comments').html("");
                    //top level comments
                    addComments(comments, '#comments');
                    $('#title').html("<span class='sub'>"+thread.sub+"</span> - "+thread.title+"<br>"+"<h4 class='sub'>"+thread.author+"</h4>");
                    $('#commentModal').modal({centered: false}).modal('show');
                });
            }
            
            //recursive function that goes through comment children and adds them to the comment div
            function addLowerComments(upperComment, div){
                let replies = upperComment.replies;
                if (replies){
                    let comments = replies.data.children;
                    addComments(comments, div);
                }
            }
            
            let test = function(){
                console.log('test');
            }
            
            //sorts and adds comments from array
            function addComments(comments, div){
                comments.sort((a,b) => b.data.created - a.data.created);
                comments.forEach((comment) => {
                    let data = comment.data;
                    let text = data.body_html;
                    let author = data.author;
                    let html = $.parseHTML(text)[0].data;
                    let commentDiv = $('<div class="ui segment" id="comment">').html(html).appendTo(div);
                    
                    let commentHeader = $('<h4 class="sub">').prependTo(commentDiv);
                    let closeComment = $("<span onclick='closeComment(this)' class='pointer'>").text('[-] ').prependTo(commentHeader);
                    let authorSpan = $("<span>").text(author).appendTo(commentHeader);
                    if (data.is_submitter) authorSpan.addClass('OP');
                    addLowerComments(data, commentDiv);
                });
            }
            
            //search results
            let timer;
            $scope.searchResults = [''];
            $scope.searchSubs = function(){
                if (timer) clearTimeout(timer);
                timer = setTimeout(function(){
                    timer = undefined;
                    $.getJSON('https://www.reddit.com/subreddits/search.json?q='+$scope.searchText, function(data){
                        $scope.searchResults = data.data.children.map((item) => item.data.display_name);
                        $scope.$apply();
                    });
                }, 500);
            };
            $scope.searchText = '';
            
            //array to store threads
            $scope.currentThreads = [];
            $scope.mute = true;
            
            //set interval for getting new data, currently every second
            setInterval(()=>{
                getNewData();
            }, 5000);
            
            getNewData();
            
            //get new data from reddit in JSON format
            function getNewData(){

                $.getJSON('https://www.reddit.com/r/'+$scope.subs+'/new.json',function(data){
                    //threads is within data.children (array)
                    let addedNew = false;
                    let threads = data.data.children;
                    
                    //for each thread, get desired data and create an object
                    threads.forEach((thread) => {
                        let data = thread.data;
                        let author = data.author;
                        let id = data.id;
                        let created = data.created;
                        let title = data.title;
                        let description = data.selftext;
                        if (description) description = $.parseHTML(description)[0].data;
                        let url = data.url;
                        let sub = data.subreddit;
                        let comments = data.permalink;
                        let domain = data.domain;
                        let numberComments = data.num_comments;
                        let obj = {id, author, created, title, description, url, sub, comments, domain, numberComments, colour: 'red'};
                        if ($scope.clickedOn.indexOf(id) !== -1) obj.colour = '';
                        if (checkExists(obj) === false){
                            //console.log(obj, " doesn't exist");
                            $scope.currentThreads.unshift(obj);
                            if ($scope.currentThreads.length > 75) $scope.currentThreads.pop();
                            addedNew = true;
                        } else {
                            $scope.currentThreads.find((thread) => thread.id === id).numberComments = numberComments;
                        }
                    });
                    
                    //if found a new thread, then sort array, play a sound and update Angular
                    if (addedNew){
                        $scope.currentThreads.sort((a,b) => b.created - a.created);
                        $scope.$apply();
                        if ($scope.mute === false){
                            sound.play();
                        }
                    }
                    
                    
                });
            }
            
            //check if a thread already exists in the array
            function checkExists(obj){
                let exists = false;
                let test = $scope.currentThreads.find((thread) => thread.id == obj.id);
                if (test !== undefined) exists = true;
                return exists;
            }
        });
        
        let closeComment = function(e){
            if ($(e).text() === '[-] ') $(e).text('[+] ');
            else $(e).text('[-] ');
            $(e).parent().parent().toggleClass('closed');
        }

        
    </script>
    
</body>

</html>

